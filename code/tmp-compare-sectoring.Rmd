---
title: "Find Disagreements in Sectoring Schemes"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(knitr.kable.NA = '')
```

```{r, message = FALSE}
library(readxl)
library(dplyr)
library(implan)
library(tidyr)
```

## Motivation

Running Implan depends on mapping spending categories ("Food - Groceries", etc.) to implan sectors. We currently store these sectoring schemes (or category-sector crosswalks) separately for different activities (fish, hunt, etc.). For efficiency, we should use a master sector scheme as a single source of truth, and only change it when (1) new categories are needed, or (2) the sectoring scheme needs updating. 

However, there is disagreement between the 4 sectoring schemes examined. As far as I can tell, these shouldn't disagree. If that is the case, then we should fix these discrepancies in a new master sectoring scheme.

The R code for this analysis [is stored here](https://github.com/southwick-associates/B4W-19-01/blob/master/code/tmp-compare-sectoring.Rmd).

### Sectoring Scheme

For reference, a few rows of the hunting sectoring scheme (note the leading 3000 was stripped from commodity sector IDs for comparison purposes):

```{r}
# load data
acts <- c("oia", "hunt", "fish", "wildlife")
infile <- "../data/raw/implan/category_to_sector536.xlsx"
ls <- acts %>%
    sapply(function(x) read_excel(infile, sheet = x) %>% mutate(act = x), simplify = FALSE)

# strip the 3000 sector designator to also test for differences in Ind/Comm
ls <- lapply(ls, function(x) {
    mutate(x, sector = ifelse(sector > 1000, sector - 3000, sector))
})

# make sure I understand the dimension
# - all TRUE (i.e., it's unique by category-sector)
# sapply(ls, function(x) {
#     nrow(distinct(x, category, sector)) == nrow(x)
# })

head(ls[[2]], 3) %>% knitr::kable()
```

## Show Duplication

There are 3 relevant variables that can potentionally disagree between activity sectoring schemes:

- Share: The proportion of the category spending allocated to a sector
- Retail: "Yes" or "No"
- Group: "Ind" (industry) or "Comm" (commodity)

### Share Disagreement

```{r}
# get category-sectors with some disagreement on var & show for each activity
# - note that NA can generally be ignored
show_disagree <- function(var, joinvars = c("category", "sector")) {
    var <- enquo(var)
    all_test <- bind_rows(ls) %>%
        distinct(category, sector, !! var)
    dup <- count(all_test, category, sector) %>% filter(n > 1)
    all_spread <- bind_rows(ls) %>%
        select(category, sector, act, !! var) %>%
        spread(act, !! var)
    semi_join(all_spread, dup, by = joinvars) %>%
        arrange(category, sector)
}
disagree_share <- show_disagree(share, "category")
disagree_share %>% knitr::kable()
```

### Retail Disagreement

```{r}
disagree_retail <- show_disagree(retail)
knitr::kable(disagree_retail)
```

### Industry/Commodity Disagreement

```{r}
disagree_group <- show_disagree(group)
knitr::kable(disagree_group)
```

### Any Disagreement

Shows complete records for those category-sectors which have some disagreement between the 4 activities (i.e., a synthesis of the 3 tables above). Note that the descriptions can disagree with Ind/Comm disagreement.

```{r}
# create a master sectoring scheme
master <- bind_rows(ls) %>%
    select(-act) %>%
    distinct()

# find disagreement in the master scheme
dups <- count(master, category, sector) %>% filter(n > 1)
disagree_combine <- semi_join(master, dups, by = c("category", "sector")) %>%
    arrange(category, sector)
knitr::kable(disagree_combine)
```


```{r}
# save relevant tables as Excel to share with Tom/Lisa
# - master
# - disagree_share
# - disagree_retail
# - disagree_group
# - disagree_combine
```

